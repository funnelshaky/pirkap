<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diseños avanzado de mallas de voladura - Cosmos Technology</title>
    <style>
        body { font-family: sans-serif; background-color: #2c3e50; color: #ecf0f1; text-align: center; padding: 15px; margin: 0; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        h1 { margin-top: 0; margin-bottom: 10px; flex-shrink: 0; }
        input[type="file"] { margin-bottom: 15px; flex-shrink: 0; }
        .chart-container { flex-grow: 1; position: relative; width: 95%; margin: 0 auto; }
        canvas { background-color: #34495e; border-radius: 8px; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #3498db; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>Diseños avanzado de mallas de voladura - Cosmos Technology</h1>
    <input type="file" id="csvFileInput" accept=".csv">
    <div class="loader" id="loader"></div>
    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        const csvFileInput = document.getElementById('csvFileInput');
        const loader = document.getElementById('loader');
        const ctx = document.getElementById('myChart').getContext('2d');
        let myChart;

        csvFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // Mostrar el spinner de carga
            loader.style.display = 'block';
            if (myChart) myChart.destroy();

            // Crear un objeto FormData para enviar el archivo
            const formData = new FormData();
            formData.append('file', file);

            try {
                // Enviar el archivo al backend de FastAPI
                const response = await fetch('http://localhost:8000/process-csv/', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Error en el servidor');
                }

                const data = await response.json();
                
                // El backend ya nos dio los datos procesados, solo hay que dibujar
                drawChartFromAPI(data.grouped_taladros, data.all_taladros);

            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                // Ocultar el spinner de carga
                loader.style.display = 'none';
            }
        });

        function drawChartFromAPI(grouped_taladros, all_taladros) {
            const datasets = [];
            const colors = ['#4BC0C0', '#FFB1C1', '#FFCE56', '#36A2EB', '#9966FF', '#FF9F40', '#E83E8C', '#6F42C1'];
            let colorIndex = 0;

            for (const prefix in grouped_taladros) {
                const taladrosOrdenados = grouped_taladros[prefix];
                const color = colors[colorIndex % colors.length];
                
                datasets.push({
                    type: 'line', label: `Secuencia ${prefix}`,
                    data: taladrosOrdenados.map(t => ({x: t.x, y: t.y})),
                    borderColor: color, borderWidth: 2, fill: false, pointRadius: 0,
                });

                datasets.push({
                    type: 'scatter', label: `Taladros ${prefix}`,
                    data: taladrosOrdenados.map(t => ({x: t.x, y: t.y})),
                    backgroundColor: color, pointRadius: 6, pointHoverRadius: 8
                });
                colorIndex++;
            }
            
            // Dibujar la gráfica
            myChart = new Chart(ctx, {
                data: { datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false, aspectRatio: 1,
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Coordenada X' } },
                        y: { title: { display: true, text: 'Coordenada Y' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const currentPoint = context.dataset.data[context.dataIndex];
                                    const taladro = all_taladros.find(t => t.x === currentPoint.x && t.y === currentPoint.y);
                                    if (taladro) {
                                        return `${taladro.label}: (${taladro.x}, ${taladro.y}) - ${taladro.tiempo}ms`;
                                    }
                                    return `(${currentPoint.x}, ${currentPoint.y})`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>